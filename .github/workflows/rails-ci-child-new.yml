name: Rails CI Child New

on:
  workflow_call:
    inputs:
      parent-workflow-id:
        description: Identifier of the parent workflow run
        required: true
        type: string
      source-repo:
        description: Repository containing the Rails source to test
        required: false
        type: string
      source-ref:
        description: Git ref of the Rails source to test
        required: false
        type: string

jobs:
  load-config:
    uses: ./.github/workflows/load-config.yml
    with:
      source-repo: ${{ inputs.source-repo != '' && inputs.source-repo || github.repository }}
      source-ref: ${{ inputs.source-ref != '' && inputs.source-ref || github.sha }}

  debug:
    name: debug loaded config
    needs: load-config
    runs-on: ubuntu-latest
    steps:
      - name: Show all outputs
        run: |
          echo "${{ toJson(needs.load-config.outputs) }}"
      - name: Show all output
        run: |
          echo "${{ needs.load-config.output }}"
      - name: Show frameworks config
        run: |
          echo "Frameworks config:"
          echo "${{ needs.load-config.outputs.frameworks }}"
      - name: Show ruby-supported
        run: |
          echo "Ruby supported:"
          echo "${{ needs.load-config.outputs.ruby-supported }}"
      - name: Show ruby-default
        run: |
          echo "Ruby default:"
          echo "${{ needs.load-config.outputs.ruby-default }}"

  actionpack:
    name: Action Pack
    needs: load-config
    uses: ./.github/workflows/framework.yml
    with:
      framework: actionpack
      matrix-json: ${{ toJson(fromJson(needs.load-config.outputs.frameworks).frameworks.actionpack) }}

  activerecord:
    name: Active Record
    needs: load-config
    uses: ./.github/workflows/framework.yml
    with:
      framework: activerecord
      matrix-json: ${{ toJson(fromJson(needs.load-config.outputs.frameworks).frameworks.activerecord) }}

  activesupport:
    name: Active Support
    needs: load-config
    uses: ./.github/workflows/framework.yml
    with:
      framework: activesupport
      matrix-json: ${{ toJson(fromJson(needs.load-config.outputs.frameworks).frameworks.activesupport) }}

  railties:
    name: Railties
    needs: load-config
    uses: ./.github/workflows/framework.yml
    with:
      framework: railties
      matrix-json: ${{ toJson(fromJson(needs.load-config.outputs.frameworks).frameworks.railties) }}
